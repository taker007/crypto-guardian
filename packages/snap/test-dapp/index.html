<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Guardian - Test dApp</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      color: #00d4aa;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 2rem;
    }
    .card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }
    .card h2 {
      margin-top: 0;
      color: #00d4aa;
      font-size: 1.2rem;
    }
    button {
      background: #00d4aa;
      color: #1a1a2e;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      transition: all 0.2s;
    }
    button:hover {
      background: #00b894;
      transform: translateY(-1px);
    }
    button:disabled {
      background: #444;
      cursor: not-allowed;
      transform: none;
    }
    .status {
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 0.9rem;
    }
    .status.success { background: rgba(0,212,170,0.2); border: 1px solid #00d4aa; }
    .status.error { background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b; }
    .status.info { background: rgba(100,149,237,0.2); border: 1px solid #6495ed; }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 1rem;
      margin-top: 8px;
    }
    input::placeholder { color: #666; }
    label {
      display: block;
      margin-top: 12px;
      color: #aaa;
      font-size: 0.9rem;
    }
    .step-number {
      display: inline-block;
      width: 28px;
      height: 28px;
      background: #00d4aa;
      color: #1a1a2e;
      border-radius: 50%;
      text-align: center;
      line-height: 28px;
      font-weight: bold;
      margin-right: 10px;
    }
    code {
      background: rgba(0,0,0,0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üõ°Ô∏è Crypto Guardian</h1>
    <p class="subtitle">Transaction Security Snap - Test dApp</p>

    <!-- Step 1: Connect MetaMask -->
    <div class="card">
      <h2><span class="step-number">1</span>Connect MetaMask Flask</h2>
      <p>Connect your MetaMask Flask wallet to this dApp.</p>
      <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
      <div id="walletStatus"></div>
    </div>

    <!-- Step 2: Install Snap -->
    <div class="card">
      <h2><span class="step-number">2</span>Install Crypto Guardian Snap</h2>
      <p>Install the snap from: <code id="snapUrl">local:http://localhost:5004</code></p>
      <button id="installBtn" onclick="installSnap()" disabled>Install Snap</button>
      <div id="snapStatus"></div>
    </div>

    <!-- Step 3: Test Transaction -->
    <div class="card">
      <h2><span class="step-number">3</span>Test Transaction</h2>
      <p>Send a test transaction to trigger the Crypto Guardian alert.</p>

      <label>Recipient Address</label>
      <input type="text" id="toAddress" placeholder="0x..." value="0x0000000000000000000000000000000000000000">

      <label>Amount (ETH)</label>
      <input type="text" id="amount" placeholder="0.001" value="0.001">

      <button id="sendBtn" onclick="sendTransaction()" disabled>Send Test Transaction</button>
      <div id="txStatus"></div>
    </div>

    <!-- Info -->
    <div class="card">
      <h2>‚ÑπÔ∏è How It Works</h2>
      <p>When you initiate a transaction, Crypto Guardian will:</p>
      <ul>
        <li>Intercept the transaction before signing</li>
        <li>Analyze for potential risks</li>
        <li>Show a security alert with risk score</li>
        <li>Let you Continue or Cancel</li>
      </ul>
      <p style="color:#ff6b6b;margin-top:15px;"><strong>Note:</strong> Requires MetaMask Flask (not regular MetaMask)</p>
    </div>
  </div>

  <script>
    const SNAP_ID = 'local:http://localhost:5004';
    let account = null;

    // Update snap URL display
    document.getElementById('snapUrl').textContent = SNAP_ID;

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.className = 'status ' + type;
      el.innerHTML = message;
    }

    async function connectWallet() {
      try {
        if (typeof window.ethereum === 'undefined') {
          showStatus('walletStatus', '‚ùå MetaMask Flask not detected. Please install it first.', 'error');
          return;
        }

        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        account = accounts[0];

        showStatus('walletStatus', `‚úÖ Connected: ${account.slice(0,6)}...${account.slice(-4)}`, 'success');
        document.getElementById('installBtn').disabled = false;
        document.getElementById('connectBtn').textContent = 'Connected';
        document.getElementById('connectBtn').disabled = true;
      } catch (err) {
        showStatus('walletStatus', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    async function installSnap() {
      try {
        showStatus('snapStatus', '‚è≥ Installing snap...', 'info');

        const result = await window.ethereum.request({
          method: 'wallet_requestSnaps',
          params: {
            [SNAP_ID]: {}
          }
        });

        console.log('Snap installed:', result);
        showStatus('snapStatus', '‚úÖ Crypto Guardian installed successfully!', 'success');
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('installBtn').textContent = 'Installed';
        document.getElementById('installBtn').disabled = true;
      } catch (err) {
        showStatus('snapStatus', `‚ùå Error: ${err.message}`, 'error');
      }
    }

    async function sendTransaction() {
      try {
        const to = document.getElementById('toAddress').value;
        const amount = document.getElementById('amount').value;

        if (!to || !amount) {
          showStatus('txStatus', '‚ùå Please enter recipient and amount', 'error');
          return;
        }

        showStatus('txStatus', '‚è≥ Sending transaction... Watch for the Crypto Guardian alert!', 'info');

        // Convert ETH to wei (hex)
        const weiValue = '0x' + (parseFloat(amount) * 1e18).toString(16);

        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [{
            from: account,
            to: to,
            value: weiValue,
            gas: '0x5208', // 21000
          }]
        });

        showStatus('txStatus', `‚úÖ Transaction sent! Hash: ${txHash.slice(0,10)}...`, 'success');
      } catch (err) {
        if (err.code === 4001) {
          showStatus('txStatus', '‚ö†Ô∏è Transaction cancelled by user', 'info');
        } else {
          showStatus('txStatus', `‚ùå Error: ${err.message}`, 'error');
        }
      }
    }

    // Check if already connected
    if (window.ethereum) {
      window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
        if (accounts.length > 0) {
          account = accounts[0];
          showStatus('walletStatus', `‚úÖ Connected: ${account.slice(0,6)}...${account.slice(-4)}`, 'success');
          document.getElementById('installBtn').disabled = false;
          document.getElementById('connectBtn').textContent = 'Connected';
          document.getElementById('connectBtn').disabled = true;
        }
      });
    }
  </script>
</body>
</html>
